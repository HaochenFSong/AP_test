---
title: "AP test application"
output: pdf_document
date: "2022-08-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Secion 1 Running POST-Diff (Code adapted from Tong)

```{r Post Diff, echo = TRUE}
TSPDD <- function(pa, pb, n, c, burnin, batch) {
  arm_a_successes <- c(0)
  arm_a_failures <- c(0)
  arm_b_successes <- c(0)
  arm_b_failures <- c(0)
  
  arm_a_s <- c(0)
  arm_a_f <- c(0)
  arm_b_s <- c(0)
  arm_b_f <- c(0)
  
  APT_1 = 0
  APT_2 = 0
  
  abl <- c()
  
  for (i in 1:burnin) {
    draw_a <- runif(1)
    draw_b <- runif(1)
    
    if (draw_a > draw_b) {
      if (runif(1) < pa) {
        abl[i] <- 1
        arm_a_s <- arm_a_s + 1
      } else {
        abl[i] <- 0
        arm_a_f <- arm_a_f + 1
      }
    }
    else{
      if (runif(1) < pb) {
        abl[i] <- 1
        arm_b_s <- arm_b_s + 1
      }
      else {
        abl[i] <- 0
        arm_b_f <- arm_b_f + 1
      }
    }
    arm_a_successes[i] <- arm_a_s
    arm_a_failures[i] <- arm_a_f
    arm_b_successes[i] <- arm_b_s
    arm_b_failures[i] <- arm_b_f
    
  }
  for (i in (burnin + 1):n) {
    m = i %% batch 
    if (m == 0){
      draw_a <-
        rbeta(1, arm_a_successes[i - 1] + 1, arm_a_failures[i - 1] + 1)
      draw_b <-
        rbeta(1, arm_b_successes[i - 1] + 1, arm_b_failures[i - 1] + 1)
    }
    else{
      draw_a <-
        rbeta(1, arm_a_successes[i - m] + 1, arm_a_failures[i - m] + 1)
      draw_b <-
        rbeta(1, arm_b_successes[i - m] + 1, arm_b_failures[i - m] + 1)
    }
    # you can change 1000 to 10000 or whatever to make the result better.
    if (abs(draw_a - draw_b) < c) {
      draw_a <- runif(1)
      draw_b <- runif(1)
    } else {
      if (m == 0){
        draw_a <-
          rbeta(1, arm_a_successes[i - 1] + 1, arm_a_failures[i - 1] + 1)
        draw_b <-
          rbeta(1, arm_b_successes[i - 1] + 1, arm_b_failures[i - 1] + 1)
      }
      else{
        draw_a <-
          rbeta(1, arm_a_successes[i - m] + 1, arm_a_failures[i - m] + 1)
        draw_b <-
          rbeta(1, arm_b_successes[i - m] + 1, arm_b_failures[i - m] + 1)
      }
      
      if (draw_b >draw_a){
        APT_1 = APT_1+1
      }
    }
    if (draw_a > draw_b) {
      if (runif(1) < pa) {
        abl[i] <- 1
        arm_a_s <- arm_a_s + 1
      } else {
        abl[i] <- 0
        arm_a_f <- arm_a_f + 1
      }
    } else{
      if (runif(1) < pb) {
        abl[i] <- 1
        arm_b_s <- arm_b_s + 1
      } else {
        abl[i] <- 0
        arm_b_f <- arm_b_f + 1
      }
    }
    if (draw_b > draw_a){
      APT_2 <- APT_2+1
    }
    arm_a_successes[i] <- arm_a_s
    arm_a_failures[i] <- arm_a_f
    arm_b_successes[i] <- arm_b_s
    arm_b_failures[i] <- arm_b_f
  }
  #na: number of times arm A was pulled. nb: same
  na <- arm_a_successes + arm_a_failures
  nb <- arm_b_successes + arm_b_failures
  pa_est <- arm_a_successes / na
  pb_est <- arm_b_successes / nb
  WaldScore <-
    (pa_est - pb_est) / sqrt(pa_est * (1 - pa_est) / na + pb_est * (1 - pb_est) /nb)
  reward <- (na * pa + nb * pb) / c(1:n)
  return(c(WaldScore[n], reward[n], APT_1, APT_2))
  
}
```

## Finding Critical Values using Normal Assumption on Law of Large Numbers:

```{r}
normal_cv <- function(APT, alpha){
  m <- mean(APT)
  v <- var(APT)
  sd <- sqrt(v)
  normal_rej <- qnorm(1-alpha)
  cv <- normal_rej * sd + m
  return(cv)
}
```

## Finding Critical Values using Empirical Assumption on Law of Large Number:

```{r}
empirical_cv <- function(APT, alpha){
  cdf = 0
  i = 0 
  while (cdf <= 1- alpha){
    p_i <-sum(APT ==i)/length(APT)
    cdf <- sum(cdf, p_i)
    i = i + 1
  }
  return(i-1)
}
```

## Calculating FPR  for case where effect size is 0, to find critical values for APT1 


```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2
N <- 15
B <- 5000
c <- 0.1
burn_in <- 2 # note that burnin needs to be 
n <-  3
Ti <- N/n
results <- array(dim = c(B, 4))
for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT1, freq = FALSE)

# emipircal CV of APT1 is
em_cv <- empirical_cv(APT1,alpha)
paste('empirical CV is', em_cv)
# normal CV of APT1 is

norm_cv <- normal_cv(APT1,alpha)
paste('normal CV is', norm_cv)

# empirical cdf of APT1 is

F1 <- ecdf(APT1)

paste('empircal FPR is', 1-F1(em_cv))
paste('normal FPR is', 1-F1(floor(norm_cv)))
```

## Calculating power when p2 -p1 = 0.05
```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0.05
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2

for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT1, freq = FALSE)

F1 <- ecdf(APT1)

paste('empircal Power is', 1-F1(em_cv))
paste('normal Power is', 1-F1(floor(norm_cv)))
```
## Calculating power when p2 -p1 = 0.1
```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0.1
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2

for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT1, freq = FALSE)

F1 <- ecdf(APT1)

paste('empircal Power is', 1-F1(em_cv))
paste('normal Power is', 1-F1(floor(norm_cv)))
```

## Calculating power when p2 -p1 = 0.2
```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0.2
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2

for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT1, freq = FALSE)

F1 <- ecdf(APT1)

paste('empircal Power is', 1-F1(em_cv))
paste('normal Power is', 1-F1(floor(norm_cv)))
```
## Calculating FPR  for case where effect size is 0, to find critical values for APT2


```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2
results <- array(dim = c(B, 4))
for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT2, freq = FALSE)

# emipircal CV of APT1 is
em_cv <- empirical_cv(APT2,alpha)
paste('empirical CV is', em_cv)
# normal CV of APT1 is

norm_cv <- normal_cv(APT2,alpha)
paste('normal CV is', norm_cv)

# empirical cdf of APT1 is

F1 <- ecdf(APT2)

paste('empircal FPR is', 1-F1(em_cv))
paste('normal FPR is', 1-F1(floor(norm_cv)))
```

## Calculating power when p2 -p1 = 0.05
```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0.05
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2

for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT2, freq = FALSE)

F1 <- ecdf(APT2)

paste('empircal Power is', 1-F1(em_cv))
paste('normal Power is', 1-F1(floor(norm_cv)))
```
## Calculating power when p2 -p1 = 0.1
```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0.1
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2

for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT2, freq = FALSE)

F1 <- ecdf(APT2)

paste('empircal Power is', 1-F1(em_cv))
paste('normal Power is', 1-F1(floor(norm_cv)))
```

## Calculating power when p2 -p1 = 0.2
```{r FPR, echo=TRUE}
set.seed(0)
#calculate power and reward in case p1>p2
alpha <- 0.05
effect_size <- 0.2
p1 <- 0.5 - effect_size / 2
p2 <- 0.5 + effect_size / 2

for (i in 1:B) {
  results[i,] <-
    TSPDD(
      pa = p1,
      pb = p2,
      n = N,
      c = c,
      burnin = burn_in, #burnin=1 means no burnin needs to be larger than batch-1
      batch = n
    ) 
}
average_power = mean(results[, 1] > 1.96)
average_reward = mean(results[, 2])
APT1 = results[,3]
APT2 = results[,4]
#Histogram of APT1
hist(APT2, freq = FALSE)

F1 <- ecdf(APT2)

paste('empircal Power is', 1-F1(em_cv))
paste('normal Power is', 1-F1(floor(norm_cv)))
```

## check for normality:

```{r}
m <- mean(APT2)
sd <- sqrt(var(APT2))

hist((APT2-m)/sd)
```

